groups:
  - name: database_alerts
    interval: 30s
    rules:
      # PostgreSQL Down
      - alert: PostgreSQLDown
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "PostgreSQL is down on {{ $labels.instance }}"
          description: "PostgreSQL database has been down for more than 1 minute"

      # High Database Connections
      - alert: HighDatabaseConnections
        expr: pg_stat_database_numbackends{datname="postgres"} > 80
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "High number of database connections"
          description: "Database has {{ $value }} active connections"

      # Low Cache Hit Ratio
      - alert: LowCacheHitRatio
        expr: |
          100 * (
            sum(pg_stat_database_blks_hit{datname="postgres"})
            / (sum(pg_stat_database_blks_hit{datname="postgres"}) + sum(pg_stat_database_blks_read{datname="postgres"}))
          ) < 90
        for: 10m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Low database cache hit ratio"
          description: "Cache hit ratio is {{ $value }}% (should be >90%)"

      # High Transaction Rollback Rate
      - alert: HighRollbackRate
        expr: |
          rate(pg_stat_database_xact_rollback{datname="postgres"}[5m])
          / (rate(pg_stat_database_xact_commit{datname="postgres"}[5m]) + rate(pg_stat_database_xact_rollback{datname="postgres"}[5m]))
          > 0.1
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "High transaction rollback rate"
          description: "{{ $value }}% of transactions are being rolled back"

      # Database Size Growing Rapidly
      - alert: DatabaseSizeGrowingRapidly
        expr: rate(pg_database_size_bytes{datname="postgres"}[1h]) > 10485760
        for: 30m
        labels:
          severity: info
          component: database
        annotations:
          summary: "Database growing rapidly"
          description: "Database is growing at {{ $value | humanize }}B/s"

      # Dead Tuples
      - alert: HighDeadTuples
        expr: (pg_stat_user_tables_n_dead_tup / (pg_stat_user_tables_n_live_tup + pg_stat_user_tables_n_dead_tup)) > 0.1
        for: 30m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "High percentage of dead tuples in {{ $labels.relname }}"
          description: "Table has {{ $value }}% dead tuples (needs VACUUM)"
